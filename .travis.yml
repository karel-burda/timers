stages:
  - example (C++11) -- build (linux, clang5), valgrind
  - example (C++14) -- cppcheck, build (linux, gcc5), valgrind
  - tests (C++14) -- cppcheck, build (osx, clang8), run

env:
  global:
    - CMAKE_EXAMPLE="cmake -Bbuild -H. -DEXAMPLE:BOOL=ON -DUNIT-TESTS:BOOL=OFF -DCMAKE_BUILD_TYPE:STRING=RelWithDebInfo"

jobs:
  fail_fast: true

  include:
    - stage: example (C++11) -- build (linux, clang5), valgrind
      sudo: required
      dist: trusty
      language: cpp
      compiler: clang
      os: linux
      before_install:
        - sudo apt-get update -qq
        - sudo apt-get -y install valgrind
      script:
        - cmake -Bbuild -H. -DEXAMPLE:BOOL=ON -DUNIT-TESTS:BOOL=OFF -DCMAKE_BUILD_TYPE:STRING=RelWithDebInfo
        - cmake --build ./build --target example --config RelWithDebInfo
        - valgrind --leak-check=full --error-exitcode=255 -v ./build/bin/example

    - stage: example (C++14) -- cppcheck, build (linux, gcc5), valgrind
      sudo: required
      dist: trusty
      language: cpp
      compiler: g++
      os: linux
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-5
            - valgrind
            - cppcheck
      before_install:
        - sudo apt-get update -qq
      install: export CXX="g++-5"
      script:
        - cppcheck --enable=all -I include --check-config  -v ./example
        - cmake -Bbuild -H. -DEXAMPLE:BOOL=ON -DUNIT-TESTS:BOOL=OFF -DCMAKE_BUILD_TYPE:STRING=RelWithDebInfo
        - cmake --build ./build --target example --config RelWithDebInfo
        - valgrind --leak-check=full --error-exitcode=255 -v ./build/bin/example

    - stage: tests (C++14) -- cppcheck, build (osx, clang8), run
      language: cpp
      compiler: clang
      os: osx
      env: GTEST_COLOR=1
      before_install:
        - brew update
        - brew install cppcheck lcov
      script:
        - cppcheck --enable=all -I include -I tests/unit/include/ --check-config  -v ./tests/unit/
        - cmake -Bbuild -H. -DEXAMPLE:BOOL=OFF -DUNIT-TESTS:BOOL=ON -DCMAKE_BUILD_TYPE:STRING=Release
        - cmake --build ./build --target run-all-tests-verbose --config Release
